name: ⛅ Update weather & timestamp

on:
  schedule:
    - cron: '*/30 * * * *'  # Every 30 minutes
  workflow_dispatch:

jobs:
  update_readme:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Fetch current temperature for Bhopal
        id: weather
        env:
          CITY: Bhopal
          COUNTRY: IN
          API_KEY: ${{ secrets.WEATHER_API_KEY }}
        run: |
          data=$(curl -s "https://api.openweathermap.org/data/2.5/weather?q=$CITY,$COUNTRY&appid=$API_KEY&units=metric")
          echo "Raw response: $data"

          # Check for error
          if echo "$data" | jq -e '.cod' | grep -q -v 200; then
            echo "❌ Error: $(echo "$data" | jq -r '.message')"
            exit 1
          fi

          temp=$(echo "$data" | jq -r '.main.temp')
          echo "weather=${temp}°C" >> "$GITHUB_OUTPUT"

      - name: Rewrite README with current time
        env:
          WEATHER: ${{ steps.weather.outputs.weather }}
        run: |
          timestamp=$(TZ="Asia/Kolkata" date +"%Y-%m-%d %H:%M %Z")
          echo "Using temperature: $WEATHER"
          echo "Using timestamp: $timestamp"

          awk '/<!-- WEATHER_SECTION_START -->/ {
            print;
            print "Temperature in 🌆 **Bhopal**: '"$WEATHER"'";
            print "_Last updated: '"$timestamp"'_";
            skip=1;
            next
          }
          /<!-- WEATHER_SECTION_END -->/ {skip=0}
          !skip' README.md > temp.md && mv temp.md README.md

      - name: Commit & push if changed
        env:
          GITHUB_TOKEN: ${{ secrets.PAT }}
        run: |
          git config user.name "Akanksha-45"
          git config user.email "official.akankshasingh45@gmail.com"
          git add README.md

          if ! git diff --cached --quiet; then
            git commit -m "chore: update Bhopal temperature & timestamp"
            git pull --rebase origin main
            git push https://x-access-token:$GITHUB_TOKEN@github.com/${{ github.repository }} HEAD:main
          else
            echo "No changes to commit"
          fi
